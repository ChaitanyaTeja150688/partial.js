#!/usr/bin/env node

var exec = require('child_process').exec
var fs = require('fs');
var path = require('path');
var os = require('os');

var EOF = os.platform() === 'win32' ? '\r\n' : '\n';
var $type = 0;

// $type == 0 - full
// $type == 1 - normal
// $type == 2 - minimum

function createDirectory(directory) {
	var arr = [];

	arr.push('controllers');

	if ($type < 2) {

		arr.push('views');
		arr.push('templates');
		arr.push('databases');
		arr.push('definitions');

		if ($type == 0) {
			arr.push('backup');
			arr.push('tests');
			arr.push('contents');
			arr.push('logs');
			arr.push('modules');
		}

		arr.push('resources');
		arr.push('public');

		arr.push('tmp');
	}

	arr.forEach(function(o) {
		var dir = path.join(directory, o);
		if (!fs.existsSync(dir))
			fs.mkdirSync(dir);
	});
};

function createFiles(directory) {
	createFileIndex(directory);
	createFileConfig(directory);

	if ($type < 2) {
		createFileViews(directory);
		createFileResource(directory);
		createFilePublic(directory);
	}

	if ($type === 0) {
		createFileTest(directory);
		createFileModules(directory);
	}

	createFileController(directory);
	createFileDebugging(directory);
}

function createFileIndex(directory) {
	var buffer = [];
	buffer.push("var framework = require('partial.js');");
	buffer.push("var http = require('http');");
	buffer.push("var os = require('os');");
	buffer.push("");
	buffer.push("var index = process.argv.indexOf('backup');");
	buffer.push("if (index !== -1) {");
	buffer.push("	framework.backup(function(err, path) {");
	buffer.push("		console.log('Backup: ' + (err ? err.toString() : path));");
	buffer.push("	});");
	buffer.push("	return;");
	buffer.push("}");
	buffer.push("");
	buffer.push("index = process.argv.indexOf('restore');");
	buffer.push("if (index !== -1) {");
	buffer.push("	var restore = process.argv[index + 1] || '';");
	buffer.push("	framework.restore(restore, function(err, path) {");
	buffer.push("		console.log('Restore: ' + (err ? err.toString() : path));");
	buffer.push("	});");
	buffer.push("	return;");
	buffer.push("}");
	buffer.push("");
	buffer.push("var port = parseInt(process.argv[2] || '8000', 10);");
	buffer.push("var debug = true;");
	buffer.push("");
	buffer.push("framework.run(http, debug, port);");
	buffer.push("");
	buffer.push("// framework.test(true);");
	buffer.push("");
	buffer.push("console.log('http://{0}:{1}/'.format(framework.ip, framework.port));");
	fs.writeFileSync(path.join(directory, 'index.js'), buffer.join(EOF));
}

function createFileConfig(directory) {
	var buffer = [];

	buffer.push("name               : my web site");
	buffer.push("version            : 1.01");
	buffer.push("secret             : your-secret-key");
	buffer.push("author             : Your company name");

	fs.writeFileSync(path.join(directory, 'config-release'), buffer.join(EOF));
	fs.writeFileSync(path.join(directory, 'config-debug'), buffer.join(EOF).replace(/true/g, 'false'));
}

function createFileViews(directory) {
	var buffer = [];
	var dir = path.join(directory, 'views');

	if (!fs.existsSync(dir))
		fs.mkdirSync(dir);

	buffer.push("@{meta('title', 'description', 'keywords')}");
	buffer.push("");
	buffer.push('<div>Hello world!</div>');

	fs.writeFileSync(path.join(dir, 'homepage.html'), buffer.join('\n'));

	buffer = [];

	buffer.push('<!DOCTYPE html>');
	buffer.push('<html>');
	buffer.push('<head>');
	buffer.push('    @{meta}');
	buffer.push('    <meta charset="utf-8" />');
	buffer.push('    <meta http-equiv="X-UA-Compatible" content="IE=10" />');
	buffer.push('    <meta name="format-detection" content="telephone=no" />');
	buffer.push('    <meta name="viewport" content="width=1024, user-scalable=yes" />');
	buffer.push('    <meta name="robots" content="all,follow" />');	
	buffer.push('    @{head}');
	buffer.push('    @{css(\'default.css\')}');
	buffer.push('    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.0.2/jquery.min.js"></script>');
	buffer.push('    @{js(\'default.js\')}');
	buffer.push('    @{favicon(\'favicon.ico\')}');
	buffer.push('<head>');
	buffer.push('<body>');
	buffer.push('');
	buffer.push('    @{body}');
	buffer.push('');
	buffer.push('</body>');
	buffer.push('</html>');

	fs.writeFileSync(path.join(dir, '_layout.html'), buffer.join(EOF));
}

function createFileResource(directory) {
	var dir = path.join(directory, 'resources');
	fs.writeFileSync(path.join(dir, 'default.resource'), 'name                : value' + EOF);
}

function createFilePublic(directory) {

	var dir = path.join(directory, 'public');

	var css = path.join(dir, 'css');
	var js = path.join(dir, 'js');
	var img = path.join(dir, 'img');

	if (!fs.existsSync(js))
		fs.mkdirSync(js);

	if (!fs.existsSync(css))
		fs.mkdirSync(css);

	if (!fs.existsSync(img))
		fs.mkdirSync(img);

	var buffer = [];
	buffer.push('User-agent: *');
	buffer.push('Allow: /');
	buffer.push('');

	fs.writeFileSync(path.join(dir, 'robots.txt'), buffer.join(EOF));

	buffer = [];
	buffer.push('@#auto-vendor-prefix#@');
	buffer.push('');
	buffer.push('@constant{ color:#505050 }');
	buffer.push('@function(property){ color:@property }');
	buffer.push('');
	buffer.push('body { padding:20px; margin:0; font:normal 12px Arial; @constant; }');
	buffer.push('div { @function(\'red\'); }');

	fs.writeFileSync(path.join(css, 'default.css'), buffer.join(EOF));

	buffer = [];
	buffer.push('$(document).ready(function() {');
    buffer.push('');
    buffer.push('});');

	fs.writeFileSync(path.join(dir, 'favicon.ico'), 'AAABAAEAICAAAAAAIACoEAAAFgAAACgAAAAgAAAAQAAAAAEAIAAAAAAAgBAAAAAAAAAAAAAAAAAAAAAAAAD///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B5eXlE+bm5n3m5uZ35ubmD////wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B5ubmCebm5lvDzuXbcJfi/7TE5P3l5ebX5ubmU+bm5gf///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Aebm5j3T2ea9fJ/j/RNX3/8ASt3/ClHf/16K4v/P1ub75ebmt+bm5jXj4+MD////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wGIn9wHfqDjvSdl4P8ASt3/AErd/wBK3f8ASt3/AErd/xZZ3/+Co+T/3uHm9ebm5pfn5+cX////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////AeXl5RHj4+MN////AQBI2yUASuHVAErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AErd/wBK3f8mZOD/nrXk/+Tk5u3m5uZ35ubmD////wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Aejo6Anm5uZf1drl2+Xl5sfm5uYl////AQBI3R8ASt/TAErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AErd/wBK3f8DTd//Q3jh/7bG5f3l5ebR5ubmU+fn5wX///8B////Af///wH///8B////Af///wH///8B5eXlB+Li4gXl5eUj1Nrmu3eb4/0fYOD/ep3j/+Lj5sXl5eUD////AQBK3UUASt77AErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AErd/wBK3f8ASt3/C1Le/2OO4v/N1eb75+fns+fn5zP///8B////Af///wH///8B////Aebm5lHm5ubL5ebmwVWE4YEUWODrAEre/wBK3f8CTN7/j6vk/+fn5yn///8BAEnYCQBK3s8ASt3/AErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AErd/xVZ3/+FpOP/3eDmz////wH///8B////Af///wGampoTbW1t5zc3N/9nZ2f/wsnX4QZP36cASt3/AErd/wBK3f8zbeD/5+fnOf///wH///8BAErfnwBK3f8ASt7zAErevQBK34kAStxpAEjbZQBK3osASt7bAErd/wBK3f8ASt3/AErd/wBK3f9pkeHR////Af///wH///8B////AQYGBk8BAQH/AAAA/wAAAP9xcXHjV4PfGQBK3+0ASt3/AErd/yBg4P/n5+c5////Af///wEAS+CTLWng90d53jEASdwF////Aebm5g/k5OQJ////AQBH2BMASt+zAErd/wBK3f8ASt3/AErd/2aP4dH///8B////Af///wH///8BAAAAYQAAAP8AAAD/AAAA/x8fH6n///8BAkvfxwBK3f8ASt3/IGDg/+fn5zn///8B////AQBL4JNEeOHz3N7jG+bm5j3k5eah3uDm3eXl5rfn5+cL////AQBJ2yEASt7tAErd/wBK3f8ASt3/Zo/h0f///wH///8B////Af///wEAAAAfAAAA4wAAAP8AAAD1AAAAQ+Dg5SEYW9/xAErd/wBK3f8gYOD/5+fnOf///wH///8BAEvgk0l84fng4ubDorjk+05/4v8oZeD/bJTku+Xl5QX///8B////AQBK4L0ASt3/AErd/wBK3f9mj+HR////Af///wH///8B////Af///wEAAAATAAAAQxwcHCXl5eaNk67j7wBL3v8ASt3/AErd/yBg4P/n5+c5////Af///wEAS+CTJmTf/ypn4f8ASt7/AErd/wBK3/cASd9d////Af///wHm5uYDE1jhxwBK3f8ASt3/AErd/2aP4dH///8B////Af///wH///8B////Af///wH///8BGVnaI0J34OkJUd7/AErd/wBK3f8ASt3/IGDg/+fn5zn///8B////AQBL4JMASt3/AErd/wBK3vMASt6fAEngMQBE2wP///8B4+PjCb3K5XkTV9/7AErd/wBK3f8ASt3/Zo/h0f///wH///8B////Af///wH///8B5eXlL+bm5jUBSts7AEre/QBK3f8ASt3/AErd/wBK3f8gYOD/5+fnOf///wH///8BAEvgkwBK3f8ASt7jAEncQwBG2AP///8B5+fnCeXl5VXT2ebDTH7i/QBK3f8ASt3/AErd/wBK3f9mj+HR////Af///wH///8B////Af///wH///8B////AQVN3D0BS979AErd/wBK3f8ASt3/AErd/yBg4P/n5+c5////Af///wEAS+CTAErd/zlx32v///8B////Aebm5gfX3Oariafj/SRj4P8ASt3/AErd/wBK3f8ASt3/AErd/2aP4dH///8B////Af///wH///8B////Af///wH///8BAEjWPQBK3P0ASt3/AErd/wBK3f8ASt3/IGDg/+fn5zn///8B////AQBL4JMUWOD/u8nlW////wH///8BHVzaKRpc4PMASt7/AEre+wBK37sASt6zAErd/wBK3f8ASt3/Zo/h0f///wH///8B////Af///wH///8B////Af///wEBS9w7AEre/QBK3f8ASt3/AErd/wBK3f8gYOD/5+fnOf///wH///8BAEvgkxRY4P/P1uWt4uLiBf///wEASdw1AErgvwBK35UASd83AEnZBwBL3X0ASt7/AErd/wBK3f9mj+HR////Af///wH///8B////Af///wH///8B////AQFL3DsASt79AErd/wBK3f8ASt3/AErd/yBg4P/m5uY95ubmBebm5gUDTeCVAUve/6O45Pvm5uaD5+fnEf///wEAOtgD1trkA+bm5hHm5uZLVoThxQBK3v8ASt3/AErd/2aP4dH///8B////Af///wH///8B////Af///wH///8BAUvcOwBK3v0ASt3/AErd/wBK3f8ASt3/IGDg/+bm5tHm5ubD5ubmw1SD4+UASt3/IGDf/7nI5f/m5ubf5ubmp+bm5pfm5uaz3N/m5Zy04/8ybOD/AErd/wBK3f8ASt3/Zo/h0f///wH///8B////Af///wH///8B////Af///wEASdw7AEre+wBK3f8ASt3/AErd/wBK3f8KUd7/R3rg/0Z64P9GeuD/Hl/f/wBK3f8ASt3/BU7f/0B24f9vluP/bpXj/0R54f8NU9//AEre/wBK3f8ASt3/AErd/wBK3f9FeeCl////Af///wH///8B////Af///wH///8B////AQBI2ycASt/ZAErd/wBK3f8ASt3/AErd/wBK3v8ASt7/AErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AEre5wBJ3k3///8B////Af///wH///8B////Af///wH///8B////AQBI2hcASd+BAEre7wBK3f0ASt/FAEnedQBL318ASt6BAEre1wBK3f8ASt3/AErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AEre9QBL358ASNwh////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wEAR9onAEnfYQBL2gf///8B////Af///wEASNsRAEretwBK3f8ASt3/AErd/wBK3f8ASt3/AErd/wBK3f8ASt3/AEre/wBK378ASd47////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wHm5uYX5ubmiefn58fm5ubD5ubmeeTk5A0ARtwhAEre+QBK3f8ASt3/AErd/wBK3f8ASt3/AErd/wBK39kASt9XAErWBf///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B4eHhB7DC5bthjOL/RHrk/1qI4v+yw+X95eXmnbLE6AMASt7TAErd/wBK3f8ASt3/AErd/wBK3+kASd1/AEfdE////wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wFZhd9BFVng+wBK3f8ASt3/AErd/w5U4P+qveTv5ubmHQBK3skASt3/AErd/wBK3vkASuCfAEnfJ////wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////AQZP34kASt3/AErd/wBK3f8ASt3/AErd/0l84vnn5+czAErglwBK3/sASt/FAErfQf///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8BAEndpwBK3f8ASt3/AErd/wBK3f8ASt3/I2Lg8d7h5R3///8BAErdIwBG2AX///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wEASuCBAErd/wBK3f8ASt3/AErd/wBK3f8OVeDB////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////AQBJ2icASt/pAErd/wBK3f8ASt3/AErf9wBK3lH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////AQBJ3zUASt+nAErd2QBK3rsASuBTAEnbA////wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8B////Af///wH///8BAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=', 'base64');
	fs.writeFileSync(path.join(js, 'default.js'), buffer.join(EOF));
}

function createFileModules(directory) {

	var dir = path.join(directory, 'modules');

	var buffer = [];
	buffer.push('exports.yourcode = function () {');
	buffer.push('    return \'Hello World\';');
	buffer.push('};');

	fs.writeFileSync(path.join(dir, 'yourcode.js'), buffer.join(EOF));
}

function createFileController(directory) {

	var dir = path.join(directory, 'controllers');
	var buffer = [];

	buffer.push('exports.install = function(framework) {');
	buffer.push('    framework.route(\'/\', view_homepage);');
	buffer.push('    framework.route(\'#401\', error401);');
	buffer.push('    framework.route(\'#403\', error403);');
	buffer.push('    framework.route(\'#404\', error404);');
	buffer.push('    framework.route(\'#408\', error408);');
	buffer.push('    framework.route(\'#431\', error431);');
	buffer.push('    framework.route(\'#500\', error500);');
	buffer.push('};');
	buffer.push('');
	buffer.push('/*');
	buffer.push('exports.models = function() {');
	buffer.push('');
	buffer.push('};');
	buffer.push('*/');
	buffer.push('');
	buffer.push('/*');
	buffer.push('exports.functions = function() {');
	buffer.push('');
	buffer.push('};');
	buffer.push('*/');
	buffer.push('');
	buffer.push('// Unauthorized');
	buffer.push('function error401() {');
	buffer.push('    var self = this;');
	buffer.push('    self.statusCode = 401;');
	buffer.push('    self.plain(utils.httpStatus(self.statusCode));');
	buffer.push('}');
	buffer.push('');
	buffer.push('// Forbidden');
	buffer.push('function error403() {');
	buffer.push('    var self = this;');
	buffer.push('    self.statusCode = 403;');
	buffer.push('    self.plain(utils.httpStatus(self.statusCode));');
	buffer.push('}');
	buffer.push('');
	buffer.push('// Not Found');
	buffer.push('function error404() {');
	buffer.push('    var self = this;');
	buffer.push('    self.statusCode = 404;');
	buffer.push('    self.plain(utils.httpStatus(self.statusCode));');
	buffer.push('}');
	buffer.push('');
	buffer.push('// Request Timeout');
	buffer.push('function error408() {');
	buffer.push('    var self = this;');
	buffer.push('    self.statusCode = 408;');
	buffer.push('    self.plain(utils.httpStatus(self.statusCode));');
	buffer.push('}');
	buffer.push('');
	buffer.push('// Request Header Fields Too Large');
	buffer.push('function error431() {');
	buffer.push('    var self = this;');
	buffer.push('    self.statusCode = 431;');
	buffer.push('    self.plain(utils.httpStatus(self.statusCode));');
	buffer.push('}');
	buffer.push('');
	buffer.push('// Internal Server Error');
	buffer.push('function error500() {');
	buffer.push('    var self = this;');
	buffer.push('    self.statusCode = 500;');
	buffer.push('    self.plain(utils.httpStatus(self.statusCode));');
	buffer.push('}');
	buffer.push('');
	buffer.push('function view_homepage() {');
	buffer.push('    var self = this;');

	if ($type !== 2)
		buffer.push('    self.view(\'homepage\');');
	else
		buffer.push('    self.plain(\'homepage\');');
	
	buffer.push('}');

	fs.writeFileSync(path.join(dir, 'default.js'), buffer.join(EOF));
}

function createFileTest(directory) {
	var dir = path.join(directory, 'tests');
	var buffer = [];

	buffer.push("var assert = require('assert');");
	buffer.push("var utils = require('partial.js/utils');");
	buffer.push("");
	buffer.push("exports.run = function(framework) {");
	buffer.push("");
	buffer.push("    framework.assert('Homepage', '/1/', function response(error, data, name, code, headers) {");
	buffer.push("        assert.ok(code === 200, name);");
	buffer.push("    });");
	buffer.push("");
	buffer.push("};");

	fs.writeFileSync(path.join(dir, 'global.js'), buffer.join(EOF));
}

function createFileDebugging(directory) {
	fs.writeFileSync(path.join(directory, 'debugging.js'), 'dmFyIGZvcmsgPSByZXF1aXJlKCdjaGlsZF9wcm9jZXNzJykuZm9yazsNCnZhciBmcyA9IHJlcXVpcmUoJ2ZzJyk7DQp2YXIgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTsNCnZhciBkaXJlY3RvcnkgPSBwcm9jZXNzLmN3ZCgpOw0KdmFyIHV0aWxzID0gcmVxdWlyZSgncGFydGlhbC5qcy91dGlscycpOw0KdmFyIFdhbGtlciA9IHJlcXVpcmUoJ3BhcnRpYWwuanMvYmFja3VwJykuV2Fsa2VyOw0KDQp2YXIgZGlyZWN0b3JpZXMgPSBbZGlyZWN0b3J5ICsgJy9jb250cm9sbGVycycsIGRpcmVjdG9yeSArICcvZGVmaW5pdGlvbnMnLCBkaXJlY3RvcnkgKyAnL21vZHVsZXMnXTsNCnZhciBmaWxlcyA9IHt9Ow0KdmFyIGZvcmNlID0gZmFsc2U7DQp2YXIgY2hhbmdlcyA9IFtdOw0KdmFyIGFwcCA9IG51bGw7DQp2YXIgc3RhdHVzID0gMDsNCnZhciBhc3luYyA9IG5ldyB1dGlscy5Bc3luYygpOw0KdmFyIHBpZCA9ICcnOw0KdmFyIHBpZEludGVydmFsID0gbnVsbDsNCnZhciBwcmVmaXggPSAnLS0tLS0tLS0tLS0tPiAnOw0KdmFyIHdhbGtlciA9IG5ldyBXYWxrZXIoKTsNCnZhciBpc0xvYWRlZCA9IGZhbHNlOw0KDQp3YWxrZXIub25GaWx0ZXIgPSBmdW5jdGlvbihwYXRoKSB7DQoJcmV0dXJuIHBhdGguaW5kZXhPZignLmpzJykgIT09IC0xOw0KfTsNCg0Kd2Fsa2VyLm9uQ29tcGxldGUgPSBmdW5jdGlvbigpIHsNCg0KCXZhciBzZWxmID0gdGhpczsNCg0KCWZzLnJlYWRkaXIoZGlyZWN0b3J5LCBmdW5jdGlvbihlcnIsIGFycikgew0KDQoJCXZhciBsZW5ndGggPSBhcnIubGVuZ3RoOw0KDQoJCWZvciAodmFyIGkgPSAwOyBpIDwgbGVuZ3RoOyBpKyspIHsNCgkJCXZhciBuYW1lID0gYXJyW2ldOw0KDQoJCQlpZiAobmFtZSA9PT0gJ2RlYnVnZ2luZy5qcycgfHwgbmFtZSA9PT0gJ2tlZXBhbGl2ZS5qcycpDQoJCQkJY29udGludWU7DQoNCgkJCWlmIChuYW1lID09PSAnY29uZmlnLWRlYnVnJyB8fCBuYW1lID09PSAnY29uZmlnLXJlbGVhc2UnIHx8IG5hbWUuaW5kZXhPZignLmpzJykgIT09IC0xKQ0KCQkJCXNlbGYuZmlsZS5wdXNoKG5hbWUpOw0KCQl9DQoNCgkJbGVuZ3RoID0gc2VsZi5maWxlLmxlbmd0aDsNCg0KCQlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7DQoJCQl2YXIgbmFtZSA9IHNlbGYuZmlsZVtpXTsNCgkJCWlmICghZmlsZXNbbmFtZV0pDQoJCQkJZmlsZXNbbmFtZV0gPSBpc0xvYWRlZCA/IDAgOiBudWxsOw0KCQl9DQoNCgkJcmVmcmVzaCgpOw0KCX0pOw0KfTsNCg0KZnVuY3Rpb24gcmVmcmVzaCgpIHsNCg0KCSB2YXIgZmlsZW5hbWVzID0gT2JqZWN0LmtleXMoZmlsZXMpOw0KCSB2YXIgbGVuZ3RoID0gZmlsZW5hbWVzLmxlbmd0aDsNCg0KCSBmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKSB7DQoNCgkgCXZhciBmaWxlbmFtZSA9IGZpbGVuYW1lc1tpXTsNCgkgCShmdW5jdGlvbihmaWxlbmFtZSkgew0KDQoJIAkJYXN5bmMuYXdhaXQoZnVuY3Rpb24obmV4dCkgew0KDQoJCSAJCWZzLnN0YXQoZmlsZW5hbWUsIGZ1bmN0aW9uKGVyciwgc3RhdCkgew0KDQoJCSAJCQlpZiAoIWVycikgew0KCQkJIAkJCXZhciB0aWNrcyA9IHN0YXQubXRpbWUuZ2V0VGltZSgpOw0KDQoJCQkgCQkJaWYgKGZpbGVzW2ZpbGVuYW1lXSAhPT0gbnVsbCAmJiBmaWxlc1tmaWxlbmFtZV0gIT09IHRpY2tzKSB7DQoJCQkgCQkJCWNoYW5nZXMucHVzaChwcmVmaXggKyBmaWxlbmFtZS5yZXBsYWNlKGRpcmVjdG9yeSwgJycpICsgIChmaWxlc1tmaWxlbmFtZV0gPT09IDAgPyAnIChhZGRlZCknIDogJyAobW9kaWZpZWQpJykpOw0KCQkJIAkJCQlmb3JjZSA9IHRydWU7DQoJCQkgCQkJfQ0KDQoJCSAJCQkJZmlsZXNbZmlsZW5hbWVdID0gdGlja3M7DQoJCQkgCQl9DQoJCQkgCQllbHNlIHsNCgkJCSAJCQlkZWxldGUgZmlsZXNbZmlsZW5hbWVdOw0KCQkJIAkJCWNoYW5nZXMucHVzaChwcmVmaXggKyBmaWxlbmFtZS5yZXBsYWNlKGRpcmVjdG9yeSwgJycpICsgJyAocmVtb3ZlZCknKTsNCgkJCSAJCQlmb3JjZSA9IHRydWU7DQoJCQkgCQl9DQoNCgkJCSAJCW5leHQoKTsNCgkJIAkJfSk7DQoJIAkJfSk7DQoNCgkgCX0pKGZpbGVuYW1lKTsNCgkgfQ0KDQoJIGFzeW5jLmNvbXBsZXRlKGZ1bmN0aW9uKCkgew0KDQoJIAlpc0xvYWRlZCA9IHRydWU7DQoJIAlzZXRUaW1lb3V0KHJlZnJlc2hfZGlyZWN0b3J5LCAyMDAwKTsNCg0KCSAJaWYgKHN0YXR1cyAhPT0gMSkNCgkgCQlyZXR1cm47DQoNCgkgCWlmICghZm9yY2UpDQoJIAkJcmV0dXJuOw0KDQoJIAlyZXN0YXJ0KCk7DQoNCgkJdmFyIGxlbmd0aCA9IGNoYW5nZXMubGVuZ3RoOw0KDQoJIAlmb3IgKHZhciBpID0gMDsgaSA8IGxlbmd0aDsgaSsrKQ0KCSAJCWNvbnNvbGUubG9nKGNoYW5nZXNbaV0pOw0KDQoJIAljaGFuZ2VzID0gW107DQoJIAlmb3JjZSA9IGZhbHNlOw0KCSB9KTsNCg0KfQ0KDQpmdW5jdGlvbiByZWZyZXNoX2RpcmVjdG9yeSgpIHsNCgl3YWxrZXIucmVzZXQoKTsNCgl3YWxrZXIud2FsayhkaXJlY3Rvcmllcyk7DQp9DQoNCmZ1bmN0aW9uIHJlc3RhcnQoKSB7DQoNCglpZiAoYXBwICE9PSBudWxsKSB7DQoJCXRyeQ0KCQl7DQoJCQlwcm9jZXNzLmtpbGwoYXBwLnBpZCk7DQoJCX0gY2F0Y2ggKGVycikge30NCgkJYXBwID0gbnVsbDsNCgl9DQoNCglhcHAgPSBmb3JrKHBhdGguam9pbihkaXJlY3RvcnksICdpbmRleC5qcycpKTsNCg0KCWFwcC5vbignbWVzc2FnZScsIGZ1bmN0aW9uKG1zZykgew0KCQlpZiAobXNnLnN1YnN0cmluZygwLCA1KSA9PT0gJ25hbWU6Jykgew0KCQkJcHJvY2Vzcy50aXRsZSA9ICdkZWJ1ZzogJyArIG1zZy5zdWJzdHJpbmcoNik7DQoJCQlyZXR1cm47DQoJCX0NCgl9KTsNCg0KCWFwcC5vbignZXhpdCcsIGZ1bmN0aW9uKCkgew0KDQoJCWlmIChzdGF0dXMgIT09IDI1NSkNCgkJCXJldHVybjsNCg0KCQlhcHAgPSBudWxsOw0KCX0pOw0KDQoJc3RhdHVzID0gMTsNCn0NCg0KcHJvY2Vzcy5vbignU0lHVEVSTScsIGZ1bmN0aW9uKCkgew0KCWZzLnVubGluayhwaWQsIG5vb3ApOw0KDQoJaWYgKGFwcCA9PT0gbnVsbCkgew0KCQlwcm9jZXNzLmV4aXQoMCk7DQoJCXJldHVybjsNCgl9DQoNCglwcm9jZXNzLmtpbGwoYXBwLnBpZCk7DQoJYXBwID0gbnVsbDsNCglwcm9jZXNzLmV4aXQoMCk7DQp9KTsNCg0KcHJvY2Vzcy5vbignU0lHSU5UJywgZnVuY3Rpb24oKSB7DQoJZnMudW5saW5rKHBpZCwgbm9vcCk7DQoNCglpZiAoYXBwID09PSBudWxsKSB7DQoJCXByb2Nlc3MuZXhpdCgwKTsNCgkJcmV0dXJuOw0KCX0NCg0KCXByb2Nlc3Mua2lsbChhcHAucGlkKTsNCglhcHAgPSBudWxsOw0KCXByb2Nlc3MuZXhpdCgwKTsNCn0pOw0KDQpwcm9jZXNzLm9uKCdleGl0JywgZnVuY3Rpb24oKSB7DQoJZnMudW5saW5rKHBpZCwgbm9vcCk7DQoNCglpZiAoYXBwID09PSBudWxsKQ0KCQlyZXR1cm47DQoNCglwcm9jZXNzLmtpbGwoYXBwLnBpZCk7DQoJYXBwID0gbnVsbDsNCn0pOw0KDQpmdW5jdGlvbiBub29wKCkge30NCg0KaWYgKHByb2Nlc3MucGlkID4gMCkgew0KCWNvbnNvbGUubG9nKHByZWZpeCArICdQSUQ6ICcgKyBwcm9jZXNzLnBpZCk7DQoJcGlkID0gcGF0aC5qb2luKGRpcmVjdG9yeSwgJ2RlYnVnZ2luZy5waWQnKTsNCglmcy53cml0ZUZpbGVTeW5jKHBpZCwgcHJvY2Vzcy5waWQpOw0KDQoJcGlkSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChmdW5jdGlvbigpIHsNCg0KCQlmcy5leGlzdHMocGlkLCBmdW5jdGlvbihleGlzdCkgew0KCQkJaWYgKGV4aXN0KQ0KCQkJCXJldHVybjsNCg0KCQkJZnMudW5saW5rKHBpZCwgbm9vcCk7DQoNCgkJCWlmIChhcHAgIT09IG51bGwpDQoJCQkJcHJvY2Vzcy5raWxsKGFwcC5waWQpOw0KDQoJCQlwcm9jZXNzLmV4aXQoMCk7DQoJCX0pOw0KDQoJfSwgMjAwMCk7DQp9DQoNCnJlc3RhcnQoKTsNCnJlZnJlc2hfZGlyZWN0b3J5KCk7', 'base64');
}

function install(directory) {
	exec('npm install partial.js', { cwd: directory }, function (error, stdout, stderr) {

	}).on('exit', function() {
		console.log('partial.js: success');
	});
}

function display_help() {
		console.log('');
		console.log('-m or -minimal   = minimal');
		console.log('-n or -normal    = normal');
		console.log('-f or -full      = full (default)');
		console.log('-v or -version   = partial.js version');
		console.log('/path/           = target (default current directory)');
		console.log('');
}

var dir = process.cwd();

for (var i = 2; i < process.argv.length; i++) {
	var arg = process.argv[i];
	var cmd = arg.toLowerCase();

	if (cmd === '-v' || cmd === '-version') {
		console.log(require('partial.js').version);
		return;
	}

	if (cmd === '-f' || cmd === '-full')
		continue;

	if (cmd === '-m' || cmd === '-minimal' || cmd === '-minimum') {
		$type = 2;
		continue;
	}

	if (cmd === '-n' || cmd === '-normal') {
		$type = 1;
		continue;
	}

	if (cmd === '-h' || cmd === '-help') {
		display_help();
		return;
	}
	
	dir = arg;
	break;
}

if (!fs.existsSync(dir)) {
	console.log('partial.js: error / directory not exists');
	return;
}

var files = fs.readdirSync(dir);
if (files.length > 0) {

	var can = true;
	for (var i = 0; i < files.length; i++) {
		var name = files[i];
		if (name[0] === '.')
			continue;
		can = false;
	}

	if (!can) {
		console.log('partial.js: error / directory is not empty');
		return;
	}
}

console.log('partial.js: creating directories');
createDirectory(dir);

console.log('partial.js: creating files');
createFiles(dir);

console.log('partial.js: installing current version partial.js');
install(dir);
